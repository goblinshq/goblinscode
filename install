#!/usr/bin/env bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
MUTED='\033[0;2m'
NC='\033[0m'

REPO="goblinshq/goblinscode"
RELEASE_TAG="goblins-latest"
INSTALL_DIR="$HOME/.opencode/bin"
BINARY_NAME="gcode"

echo -e "${MUTED}Installing ${NC}gcode${MUTED}...${NC}"

# Detect OS and arch
os=$(uname -s | tr '[:upper:]' '[:lower:]')
arch=$(uname -m)

case "$os" in
    darwin) ;;
    linux) ;;
    *) echo -e "${RED}Unsupported OS: $os${NC}"; exit 1 ;;
esac

if [[ "$arch" == "aarch64" ]]; then arch="arm64"; fi
if [[ "$arch" == "x86_64" ]]; then arch="x64"; fi

# Handle Rosetta on macOS
if [[ "$os" == "darwin" && "$arch" == "x64" ]]; then
    rosetta=$(sysctl -n sysctl.proc_translated 2>/dev/null || echo 0)
    if [[ "$rosetta" == "1" ]]; then
        arch="arm64"
    fi
fi

target="${os}-${arch}"
asset_name="gcode-${target}"
url="https://github.com/${REPO}/releases/download/${RELEASE_TAG}/${asset_name}"

echo -e "${MUTED}Downloading ${NC}${asset_name}${MUTED}...${NC}"

# Download to temp file first, then atomically move (safe for auto-update while running)
mkdir -p "$INSTALL_DIR"
tmp_file="${TMPDIR:-/tmp}/gcode-download-$$"
if ! curl -sfL "$url" -o "$tmp_file"; then
    echo -e "${RED}Failed to download binary from: $url${NC}"
    echo -e "${MUTED}Available platforms: darwin-arm64, linux-x64, linux-arm64${NC}"
    rm -f "$tmp_file"
    exit 1
fi
chmod 755 "$tmp_file"

# Remove quarantine/provenance attributes and sign on macOS (before moving)
if [[ "$os" == "darwin" ]]; then
    xattr -cr "$tmp_file" 2>/dev/null || true
    if ! codesign -s - "$tmp_file" --force 2>/dev/null; then
        echo -e "${RED}Warning: Failed to sign binary. gcode may not run.${NC}"
        echo -e "${MUTED}Install Xcode Command Line Tools and re-run this installer:${NC}"
        echo -e "  xcode-select --install"
        echo -e ""
    fi
    xattr -cr "$tmp_file" 2>/dev/null || true
fi

# Atomic move to final location
mv -f "$tmp_file" "$INSTALL_DIR/$BINARY_NAME"

version=$("$INSTALL_DIR/$BINARY_NAME" --version 2>/dev/null || echo "unknown")
echo -e ""
echo -e "${GREEN}Successfully installed $BINARY_NAME ${NC}$version"
echo -e ""

# Add to PATH in shell config if needed
PATH_EXPORT="export PATH=$INSTALL_DIR:\$PATH"
SHELL_CONFIG=""

if [[ -f "$HOME/.zshrc" ]]; then
    SHELL_CONFIG="$HOME/.zshrc"
elif [[ -f "$HOME/.bashrc" ]]; then
    SHELL_CONFIG="$HOME/.bashrc"
elif [[ -f "$HOME/.bash_profile" ]]; then
    SHELL_CONFIG="$HOME/.bash_profile"
fi

if [[ -n "$SHELL_CONFIG" ]]; then
    if ! grep -q "$INSTALL_DIR" "$SHELL_CONFIG"; then
        echo -e "\n# gcode (opencode goblins)" >> "$SHELL_CONFIG"
        echo "$PATH_EXPORT" >> "$SHELL_CONFIG"
        echo -e "${MUTED}Added ${NC}$INSTALL_DIR${MUTED} to PATH in ${NC}$SHELL_CONFIG"
    fi
else
    echo -e "${MUTED}No shell config found. Add to your shell config:${NC}"
    echo -e "  $PATH_EXPORT"
fi

echo -e ""
echo -e "${MUTED}Run: ${NC}$BINARY_NAME"
echo -e "${MUTED}Update: ${NC}curl -fsSL https://raw.githubusercontent.com/${REPO}/main/install | bash"
